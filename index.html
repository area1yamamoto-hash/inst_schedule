<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Instagramæœˆé–“æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå…±æœ‰ç‰ˆï¼è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fbf8;color:#2d3748;line-height:1.6;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{background:#fff;padding:24px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.05);text-align:center}
    h1{color:#1a365d;font-size:2em;margin-bottom:12px}
    .month-year{display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:12px}
    .month-year input,.month-year select{padding:8px 12px;border:2px solid #48bb78;border-radius:6px;font-size:1.05em;background:#fff}
    .status{display:inline-block;margin-top:8px;padding:4px 10px;border-radius:999px;font-size:.8em;background:#edf2f7;color:#2d3748}
    .status.ok{background:#c6f6d5}
    .status.warn{background:#fed7d7}

    .instructions{background:#fff;color:#203744;padding:20px 24px;border-radius:8px;margin-bottom:16px;border-left:4px solid #48bb78;line-height:1.8}
    .instructions h3{margin-bottom:10px}
    .instructions ul{margin-left:20px}
    .instructions li{margin-bottom:6px}

    .legend{display:flex;gap:16px;justify-content:center;margin:16px 0;flex-wrap:wrap}
    .legend-item{display:flex;align-items:center;gap:8px;font-size:.9em}
    .legend-color{width:16px;height:16px;border-radius:3px}

    .controls{display:flex;gap:12px;justify-content:center;margin:16px 0;flex-wrap:wrap}
    .btn{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all .2s}
    .btn-primary{background:#48bb78;color:#fff}
    .btn-primary:hover{background:#38a169}
    .btn-secondary{background:#e2e8f0;color:#2d3748}
    .btn-secondary:hover{background:#cbd5e0}

    .schedule-container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);margin-bottom:20px}
    .schedule-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:8px 0}
    .day-header{background:#2d3748;color:#fff;padding:10px 8px;text-align:center;border-radius:6px;font-weight:600;font-size:.9em}
    .day-cell{background:#f7fafc;padding:8px;border-radius:6px;border:2px solid #e2e8f0;min-height:110px;font-size:.85em;position:relative;cursor:pointer;transition:all .2s}
    .day-cell:hover{border-color:#48bb78;background:#f0fff4}
    .day-number{font-weight:600;color:#4a5568;margin-bottom:4px}
    .post-content{background:#48bb78;color:#fff;padding:4px 6px;border-radius:4px;font-size:.8em;margin:2px 0;font-weight:500;word-break:break-word}
    .post-content.sports{background:#e53e3e}
    .post-content.culture{background:#3182ce}
    .post-content.tourism{background:#d69e2e}
    .post-content.company{background:#805ad5}
    .post-content.story{background:#66cdaa}
    .post-content.reel{background:#ffc0cb}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}
    .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:24px;border-radius:12px;max-width:520px;width:92%}
    .modal input,.modal select,.modal textarea{width:100%;padding:8px 12px;border:2px solid #e2e8f0;border-radius:6px;margin-bottom:12px;font-size:1em}
    .modal textarea{min-height:80px;resize:vertical}
    .modal-buttons{display:flex;gap:12px;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“… Instagramæœˆé–“æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå…±æœ‰ç‰ˆï¼‰</h1>
      <div class="month-year">
        <select id="month" aria-label="æœˆ"></select>
        <label for="month">æœˆ</label>
        <input type="number" id="year" min="2024" max="2035" aria-label="å¹´">
        <label for="year">å¹´</label>
      </div>
      <div id="modeStatus" class="status">åˆæœŸåŒ–ä¸­â€¦</div>
    </div>

    <div class="instructions">
      <h3>ğŸ“ ä½¿ã„æ–¹</h3>
      <ul>
        <li><strong>æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯:</strong> äºˆå®šã‚’è¿½åŠ ãƒ»ç·¨é›†ã§ãã¾ã™</li>
        <li><strong>ä¿å­˜å…ˆ:</strong> Firestore ãŒä½¿ãˆãªã„ç’°å¢ƒã§ã¯è‡ªå‹•ã§ <u>ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</u> ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™</li>
        <li><strong>é€±2å›æŠ•ç¨¿:</strong> ç«æ›œï¼ˆ12:00ï¼‰ãƒ»é‡‘æ›œï¼ˆ17:00ï¼‰ã‚’åŸºæœ¬ã«ã—ã¦ã„ã¾ã™</li>
        <li><strong>ãƒªãƒ¼ãƒ«å‹•ç”»:</strong> æœˆ1ï½2å›ã‚’ç›®å®‰ã«æŠ•ç¨¿</li>
        <li><strong>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚º:</strong> æ—¥å¸¸çš„ãªã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå‘ä¸Šã«æ´»ç”¨</li>
      </ul>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="legend-color" style="background:#e53e3e"></div><span>ã‚¹ãƒãƒ¼ãƒ„</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#3182ce"></div><span>æ–‡åŒ–</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#d69e2e"></div><span>è¦³å…‰</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#805ad5"></div><span>ä¼æ¥­</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#66cdaa"></div><span>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚º</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#ffc0cb"></div><span>ãƒªãƒ¼ãƒ«å‹•ç”»</span></div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" onclick="generateSchedule()">ğŸ“‹ åŸºæœ¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆ</button>
      <button class="btn btn-secondary" onclick="clearSchedule()">ğŸ—‘ï¸ ã“ã®æœˆã‚’ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="schedule-container">
      <div class="schedule-grid" id="calendar"></div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>æŠ•ç¨¿äºˆå®šç·¨é›†</h3>
      <input type="text" id="postTitle" placeholder="æŠ•ç¨¿ã‚¿ã‚¤ãƒˆãƒ«" />
      <select id="postCategory">
        <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
        <option value="sports">ã‚¹ãƒãƒ¼ãƒ„</option>
        <option value="culture">æ–‡åŒ–</option>
        <option value="tourism">è¦³å…‰</option>
        <option value="company">ä¼æ¥­</option>
        <option value="story">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚º</option>
        <option value="reel">ãƒªãƒ¼ãƒ«å‹•ç”»</option>
      </select>
      <textarea id="postNote" placeholder="ãƒ¡ãƒ¢ãƒ»è©³ç´°å†…å®¹"></textarea>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="savePost()">ä¿å­˜</button>
        <button class="btn" style="background:#e53e3e;color:#fff" onclick="deletePost()">å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBN1ZmXlVSgKY7qiQ0QWe_vbc2AfrEh14E",
      authDomain: "inst-schedule.firebaseapp.com",
      projectId: "inst-schedule",
    };

    const modeStatus = document.getElementById('modeStatus');
    const hasFirebaseLib = typeof window.firebase !== 'undefined';
    let useFirestore = false;
    let db = null;

    try {
      if (hasFirebaseLib && firebaseConfig.projectId && !/YOUR_PROJECT_ID/.test(firebaseConfig.projectId) && firebaseConfig.apiKey && !/YOUR_API_KEY/.test(firebaseConfig.apiKey)) {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        useFirestore = true;
        modeStatus.textContent = 'ä¿å­˜å…ˆ: Firestoreï¼ˆå…±æœ‰ãƒ¢ãƒ¼ãƒ‰ï¼‰';
        modeStatus.classList.add('ok');
      } else {
        modeStatus.textContent = 'ä¿å­˜å…ˆ: ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆç«¯æœ«å†…ã®ã¿ï¼‰';
        modeStatus.classList.add('warn');
      }
    } catch (e) {
      console.warn('FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«åˆ‡æ›¿ãˆã¾ã™ã€‚', e);
      useFirestore = false;
      modeStatus.textContent = 'ä¿å­˜å…ˆ: ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆç«¯æœ«å†…ã®ã¿ï¼‰';
      modeStatus.classList.add('warn');
    }

    const LS_KEY = 'sns_shared_schedule_v1';
    const STORAGE = useFirestore ? {
      async loadAll(){
        const data = {};
        try{
          const snapshot = await db.collection('schedules').get();
          snapshot.forEach(doc => { data[doc.id] = doc.data().posts || []; });
        }catch(err){
          console.error('Firestoreèª­ã¿è¾¼ã¿å¤±æ•—ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã«åˆ‡æ›¿ãˆ', err);
          return LOCAL_STORAGE.loadAll();
        }
        return data;
      },
      async saveAll(obj){
        const batch = db.batch();
        Object.keys(obj).forEach(key=>{ batch.set(db.collection('schedules').doc(key), { posts: obj[key] }); });
        await batch.commit();
      },
      async deleteKeys(keys){
        const batch = db.batch();
        keys.forEach(k=> batch.delete(db.collection('schedules').doc(k)) );
        await batch.commit();
      }
    } : null;

    const LOCAL_STORAGE = {
      async loadAll(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch{return {}} },
      async saveAll(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); },
      async deleteKeys(keys){ const data = await this.loadAll(); keys.forEach(k=>delete data[k]); await this.saveAll(data); }
    };

    const Store = STORAGE || LOCAL_STORAGE;

    let scheduleData = {};
    let currentEditingDay = null;
    let editingIndex = null;

    function initMonthOptions(){
      const monthSel = document.getElementById('month');
      monthSel.innerHTML = '';
      for(let m=1;m<=12;m++){
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = m;
        if(m === new Date().getMonth()+1) opt.selected = true;
        monthSel.appendChild(opt);
      }
      document.getElementById('year').value = new Date().getFullYear();
    }

    function pad(n){ return String(n).padStart(2,'0'); }
    function keyFromDate(date){ return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`; }

    function generateCalendar(){
      const month = parseInt(document.getElementById('month').value,10);
      const year  = parseInt(document.getElementById('year').value,10);
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'].forEach(d=>{
        const h = document.createElement('div');
        h.className = 'day-header'; h.textContent = d; calendar.appendChild(h);
      });

      const firstDay = new Date(year, month-1, 1);
      const startDate = new Date(firstDay);
      const offset = (firstDay.getDay() + 6) % 7;
      startDate.setDate(startDate.getDate() - offset);

      for(let i=0;i<42;i++){
        const date = new Date(startDate);
        date.setDate(startDate.getDate()+i);

        const cell = document.createElement('div');
        cell.className = 'day-cell';
        if(date.getMonth() !== month-1) cell.style.opacity = '0.35';

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = date.getDate();
        cell.appendChild(dayNumber);

        const k = keyFromDate(date);
        (scheduleData[k]||[]).forEach((post, idx)=>{
          const div = document.createElement('div');
          div.className = `post-content ${post.category||''}`;
          div.textContent = post.title || '(ç„¡é¡Œ)';
          div.title = post.note || '';
          div.addEventListener('click', e=>{ e.stopPropagation(); editPost(date, idx); });
          cell.appendChild(div);
        });

        cell.addEventListener('click', ()=> editPost(date));
        calendar.appendChild(cell);
      }
    }

    function editPost(date,index=null){
      currentEditingDay=date;
      editingIndex=index;
      const k=keyFromDate(date);
      const post=(index!==null && scheduleData[k])?scheduleData[k][index]:null;
      document.getElementById('postTitle').value=post?post.title:'';
      document.getElementById('postCategory').value=post?post.category:'';
      document.getElementById('postNote').value=post?post.note:'';
      document.getElementById('editModal').style.display='block';
    }

    function closeModal(){ document.getElementById('editModal').style.display='none'; currentEditingDay=null; editingIndex=null; }

    async function savePost(){
      if(!currentEditingDay) return;
      const title=document.getElementById('postTitle').value.trim();
      const category=document.getElementById('postCategory').value;
      const note=document.getElementById('postNote').value.trim();
      if(!title||!category){ alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚«ãƒ†ã‚´ãƒªã¯å¿…é ˆã§ã™ã€‚'); return; }
      const k=keyFromDate(currentEditingDay);
      if(!scheduleData[k]) scheduleData[k]=[];
      if(editingIndex!==null) scheduleData[k][editingIndex]={title,category,note};
      else scheduleData[k].push({title,category,note});
      try{ await Store.saveAll(scheduleData); }catch(err){ alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚'); console.error(err); }
      generateCalendar();
      closeModal();
    }

    async function deletePost(){
      if(!currentEditingDay) return;
      const k=keyFromDate(currentEditingDay);
      if(editingIndex!==null && scheduleData[k]){
        scheduleData[k].splice(editingIndex,1);
        if(scheduleData[k].length===0) delete scheduleData[k];
      }
      try{ await Store.saveAll(scheduleData); }catch(err){ console.error(err); }
      generateCalendar();
      closeModal();
    }

    async function clearSchedule(){
      const month=parseInt(document.getElementById('month').value,10);
      const year=parseInt(document.getElementById('year').value,10);
      const keys=Object.keys(scheduleData).filter(k=>{
        const [yy,mm]=k.split('-').map(Number); return yy===year && mm===month;
      });
      keys.forEach(k=> delete scheduleData[k]);
      try{
        if(useFirestore) await STORAGE.deleteKeys(keys);
        await Store.saveAll(scheduleData);
      }catch(err){ console.error(err); }
      generateCalendar();
      alert(`${year}å¹´${month}æœˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    }

    async function generateSchedule(){
      const month=parseInt(document.getElementById('month').value,10);
      const year=parseInt(document.getElementById('year').value,10);
      const lastDay=new Date(year,month,0).getDate();
      const templates=[
        {title:'ãƒ–ãƒ¬ã‚¤ãƒ´ã‚­ãƒ³ã‚°ã‚¹åˆˆè°· å¿œæ´',category:'sports',note:'å®šæœŸï¼šç«æ›œ12:00ãƒ»é‡‘æ›œ17:00'},
        {title:'å®‰åŸå¸‚æ­´å²åšç‰©é¤¨ ç‰¹åˆ¥å±•',category:'culture',note:'å®šæœŸï¼šç«æ›œ12:00ãƒ»é‡‘æ›œ17:00'},
        {title:'åˆˆè°·ãƒã‚¤ã‚¦ã‚§ã‚¤ã‚ªã‚¢ã‚·ã‚¹',category:'tourism',note:'å®šæœŸï¼šç«æ›œ12:00ãƒ»é‡‘æ›œ17:00'},
        {title:'ã‚¨ãƒªã‚¢ãƒ¯ãƒ³åœ°åŸŸè²¢çŒ®æ´»å‹•',category:'company',note:'å®šæœŸï¼šç«æ›œ12:00ãƒ»é‡‘æ›œ17:00'}
      ];
      let idx=0;
      for(let d=1;d<=lastDay;d++){
        const date=new Date(year,month-1,d);
        const dow=date.getDay();
        if(dow===2||dow===5){
          const k=keyFromDate(date);
          if(!scheduleData[k]) scheduleData[k]=[];
          const tpl=templates[idx % templates.length];
          scheduleData[k].push({title:tpl.title,category:tpl.category,note:tpl.note});
          idx++;
        }
      }
      try{ await Store.saveAll(scheduleData); }catch(err){ console.error(err); }
      generateCalendar();
      alert('ã“ã®æœˆã®åŸºæœ¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    async function loadSchedule(){
      try{ scheduleData=await Store.loadAll(); }catch(err){ console.error('èª­ã¿è¾¼ã¿å¤±æ•—ã€‚ç©ºãƒ‡ãƒ¼ã‚¿ã§èµ·å‹•',err); scheduleData={}; }
    }

    window.addEventListener('DOMContentLoaded',async ()=>{
      initMonthOptions();
      await loadSchedule();
      generateCalendar();
      document.getElementById('month').addEventListener('change', generateCalendar);
      document.getElementById('year').addEventListener('change', generateCalendar);
    });

    document.getElementById('editModal').addEventListener('click',(e)=>{ if(e.target.id==='editModal') closeModal(); });
  </script>
</body>
</html>
