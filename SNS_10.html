<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instagram月間投稿スケジュール</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fbf8;color:#2d3748;line-height:1.6;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{background:#fff;padding:24px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.05);text-align:center}
    h1{color:#1a365d;font-size:2em;margin-bottom:12px}
    .month-year{display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:20px}
    .month-year input,.month-year select{padding:8px 12px;border:2px solid #48bb78;border-radius:6px;font-size:1.1em;background:#fff}
    .schedule-container{background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);margin-bottom:20px}
    .schedule-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:16px 0}
    .day-header{background:#2d3748;color:#fff;padding:12px 8px;text-align:center;border-radius:6px;font-weight:600;font-size:.9em}
    .day-cell{background:#f7fafc;padding:8px;border-radius:6px;border:2px solid #e2e8f0;min-height:120px;font-size:.85em;position:relative;cursor:pointer;transition:all .2s}
    .day-cell:hover{border-color:#48bb78;background:#f0fff4}
    .day-number{font-weight:600;color:#4a5568;margin-bottom:4px}
    .post-content{background:#48bb78;color:#fff;padding:4px 6px;border-radius:4px;font-size:.8em;margin:2px 0;font-weight:500;word-break:break-word}
    .post-content.sports{background:#e53e3e}
    .post-content.culture{background:#3182ce}
    .post-content.tourism{background:#d69e2e}
    .post-content.company{background:#805ad5}
    .post-content.stories{background:#48bb78;border:2px dashed #fff}
    .legend{display:flex;gap:16px;justify-content:center;margin:20px 0;flex-wrap:wrap}
    .legend-item{display:flex;align-items:center;gap:8px;font-size:.9em}
    .legend-color{width:16px;height:16px;border-radius:3px}
    .controls{display:flex;gap:12px;justify-content:center;margin:20px 0;flex-wrap:wrap}
    .btn{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all .2s}
    .btn-primary{background:#48bb78;color:#fff}
    .btn-primary:hover{background:#38a169}
    .btn-secondary{background:#e2e8f0;color:#2d3748}
    .btn-secondary:hover{background:#cbd5e0}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000}
    .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:24px;border-radius:12px;max-width:500px;width:90%}
    .modal input,.modal select,.modal textarea{width:100%;padding:8px 12px;border:2px solid #e2e8f0;border-radius:6px;margin-bottom:12px;font-size:1em}
    .modal textarea{min-height:80px;resize:vertical}
    .modal-buttons{display:flex;gap:12px;justify-content:flex-end}

    .instructions{
      background:#fff;
      color:#203744;
      padding:20px 24px;
      border-radius:8px;
      margin-bottom:20px;
      border-left:4px solid #48bb78;
      line-height:1.8;
    }
    .instructions h3{margin-bottom:12px}
    .instructions ul{margin-left:20px}
    .instructions li{margin-bottom:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📅 Instagram月間投稿スケジュール</h1>
      <div class="month-year">
        <select id="month" aria-label="月"></select>
        <label for="month">月</label>
        <input type="number" id="year" value="2025" min="2024" max="2030" aria-label="年">
        <label for="year">年</label>
      </div>
    </div>

    <div class="instructions">
      <h3>📝 使い方</h3>
      <ul>
        <li><strong>日付クリック:</strong> 投稿予定を追加・編集できます</li>
        <li><strong>カテゴリ選択:</strong> スポーツ、文化、観光、企業活動、ストーリーズから選択</li>
        <li><strong>⚠️ データ保存について:</strong> Claude環境では一時保存のみ（ページ更新で消去）</li>
        <li><strong>週2回投稿:</strong> 火曜（12:00）・金曜（17:00）の定期投稿を基本とします</li>
        <li><strong>ストーリーズ:</strong> 日常的なエンゲージメント向上に活用</li>
        <li><strong>リール投稿:</strong> 月1〜2回を目安に実施</li>
        <li><strong>💡 ヒント:</strong> 重要なスケジュールは別途コピーして保存することをお勧めします</li>
      </ul>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="legend-color" style="background:#e53e3e"></div><span>スポーツ・ホームタウン</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#3182ce"></div><span>文化・教育施設</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#d69e2e"></div><span>観光・飲食</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#805ad5"></div><span>企業活動・地域貢献</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#48bb78;border:2px dashed #ccc"></div><span>ストーリーズ</span></div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" onclick="generateSchedule()">📋 基本スケジュール生成</button>
      <button class="btn btn-secondary" onclick="clearSchedule()">🗑️ この月をクリア</button>
      <button class="btn btn-secondary" onclick="exportSchedule()" style="background:#38b2ac;color:#fff">📤 データエクスポート</button>
    </div>

    <div class="schedule-container">
      <div class="schedule-grid" id="calendar"></div>
    </div>
  </div>

  <!-- 編集モーダル -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>投稿予定編集</h3>
      <input type="text" id="postTitle" placeholder="投稿タイトル">
      <select id="postCategory">
        <option value="">カテゴリを選択</option>
        <option value="sports">スポーツ・ホームタウン</option>
        <option value="culture">文化・教育施設</option>
        <option value="tourism">観光・飲食</option>
        <option value="company">企業活動・地域貢献</option>
        <option value="stories">ストーリーズ</option>
      </select>
      <textarea id="postNote" placeholder="メモ・詳細内容"></textarea>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeModal()">キャンセル</button>
        <button class="btn btn-primary" onclick="savePost()">保存</button>
        <button class="btn" style="background:#e53e3e;color:#fff" onclick="deletePost()">削除</button>
      </div>
    </div>
  </div>

  <script>
    let scheduleData = {};
    let currentEditingDay = null;
    let editingIndex = null;

    /* -------- メモリ内データ管理 -------- */
    function loadSchedule(){
      // Claude環境用の改善された初期化
      if (typeof scheduleData === 'undefined') {
        scheduleData = {};
      }
      
      // セッションストレージから復元を試行（Claude環境では制限あり）
      try {
        const saved = sessionStorage.getItem('tempScheduleData');
        if (saved) {
          const parsedData = JSON.parse(saved);
          // 既存データとマージ
          Object.assign(scheduleData, parsedData);
          console.log("セッションデータを復元しました");
        }
      } catch (storageError) {
        console.log("セッションストレージは使用できません（Claude環境の制限）");
      }
      
      console.log("スケジュールデータを初期化しました - エントリ数:", Object.keys(scheduleData).length);
    }
    
    function saveSchedule(){
      // メモリ内保存の確認
      const entryCount = Object.keys(scheduleData).length;
      console.log("現在のスケジュールデータ:", entryCount + "個のエントリ");
      
      // セッションストレージへの保存を試行
      try {
        sessionStorage.setItem('tempScheduleData', JSON.stringify(scheduleData));
        console.log("セッションストレージに保存しました");
      } catch (storageError) {
        console.log("セッションストレージに保存できませんでした（Claude環境の制限）");
      }
      
      console.log("スケジュールデータを保存しました（メモリ内）");
    }

    function clearSchedule(){
      const month = parseInt(document.getElementById("month").value, 10);
      const year = parseInt(document.getElementById("year").value, 10);
      
      // 現在選択している月のデータのみを対象にする
      const currentMonthKeys = Object.keys(scheduleData).filter(key => {
        const [keyYear, keyMonth] = key.split('-').map(Number);
        return keyYear === year && keyMonth === month;
      });
      
      // データが空の場合の処理を追加
      if(currentMonthKeys.length === 0){
        showCustomAlert(`${year}年${month}月に削除するスケジュールがありません。`);
        return;
      }
      
      // カスタム確認ダイアログを表示
      showCustomConfirm(
        `${year}年${month}月のスケジュールを全て削除しますか？\n（${currentMonthKeys.length}個のスケジュールが削除されます）\n\n※他の月のデータは保持されます`,
        () => {
          try {
            // 選択した月のキーのみを削除
            currentMonthKeys.forEach(key => {
              delete scheduleData[key];
            });
            
            saveSchedule();
            generateCalendar();
            showCustomAlert(`${year}年${month}月のスケジュールを削除しました。\n（削除数: ${currentMonthKeys.length}個）`);
          } catch (error) {
            console.error("スケジュールクリアでエラーが発生しました:", error);
            showCustomAlert("削除中にエラーが発生しました。ページを再読み込みしてください。");
          }
        }
      );
    }

    /* -------- 月/年 UI -------- */
    function initMonthOptions(){
      const select = document.getElementById("month");
      select.innerHTML = "";
      for(let m=1;m<=12;m++){
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m; // 数字のみ
        if(m === new Date().getMonth()+1) opt.selected = true;
        select.appendChild(opt);
      }
    }

    /* -------- カレンダー描画 -------- */
    function generateCalendar(){
      const month = parseInt(document.getElementById("month").value,10);
      const year  = parseInt(document.getElementById("year").value,10);
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";

      const headers = ["月","火","水","木","金","土","日"];
      headers.forEach(d=>{
        const h = document.createElement("div");
        h.className = "day-header";
        h.textContent = d;
        calendar.appendChild(h);
      });

      const firstDay = new Date(year, month-1, 1);
      const startDate = new Date(firstDay);
      const offset = (firstDay.getDay() + 6) % 7; // 月曜基準
      startDate.setDate(startDate.getDate() - offset);

      for(let i=0;i<42;i++){
        const date = new Date(startDate);
        date.setDate(startDate.getDate()+i);

        const cell = document.createElement("div");
        cell.className = "day-cell";
        if(date.getMonth() !== month-1) cell.style.opacity = "0.35";

        const dayNumber = document.createElement("div");
        dayNumber.className = "day-number";
        dayNumber.textContent = date.getDate();
        cell.appendChild(dayNumber);

        const key = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
        if(scheduleData[key]){
          scheduleData[key].forEach((post, idx)=>{
            const div = document.createElement("div");
            div.className = `post-content ${post.category||""}`;
            div.textContent = post.title || "(無題)";
            div.title = post.note || "";
            div.addEventListener("click", e=>{
              e.stopPropagation();
              editPost(date, idx);
            });
            cell.appendChild(div);
          });
        }

        cell.addEventListener("click", ()=>editPost(date));
        calendar.appendChild(cell);
      }
    }

    /* -------- モーダル編集 -------- */
    function editPost(date, index=null){
      currentEditingDay = date;
      editingIndex = index;

      const key = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
      const post = (index!==null && scheduleData[key]) ? scheduleData[key][index] : null;

      document.getElementById("postTitle").value    = post ? (post.title||"")    : "";
      document.getElementById("postCategory").value = post ? (post.category||"") : "";
      document.getElementById("postNote").value     = post ? (post.note||"")     : "";

      document.getElementById("editModal").style.display = "block";
    }
    function closeModal(){
      document.getElementById("editModal").style.display = "none";
      currentEditingDay = null;
      editingIndex = null;
    }
    function savePost(){
      if(!currentEditingDay) return;
      const title = document.getElementById("postTitle").value.trim();
      const category = document.getElementById("postCategory").value;
      const note = document.getElementById("postNote").value.trim();
      if(!title || !category){
        showCustomAlert("タイトルとカテゴリは必須です。");
        return;
      }
      const key = `${currentEditingDay.getFullYear()}-${currentEditingDay.getMonth()+1}-${currentEditingDay.getDate()}`;
      if(!scheduleData[key]) scheduleData[key] = [];
      if(editingIndex !== null){
        scheduleData[key][editingIndex] = { title, category, note };
      }else{
        scheduleData[key].push({ title, category, note });
      }
      saveSchedule();
      generateCalendar();
      closeModal();
    }
    function deletePost(){
      if(!currentEditingDay) return;
      const key = `${currentEditingDay.getFullYear()}-${currentEditingDay.getMonth()+1}-${currentEditingDay.getDate()}`;
      if(editingIndex !== null && scheduleData[key]){
        scheduleData[key].splice(editingIndex,1);
        if(scheduleData[key].length===0) delete scheduleData[key];
      }
      saveSchedule();
      generateCalendar();
      closeModal();
    }

    /* -------- 基本スケジュール生成 -------- */
    function generateSchedule(){
      const month = parseInt(document.getElementById("month").value,10);
      const year  = parseInt(document.getElementById("year").value,10);
      const lastDay = new Date(year, month, 0).getDate();

      const templates = [
        { title: "ブレイヴキングス刈谷 応援", category: "sports",  note: "定期：火曜12:00・金曜17:00" },
        { title: "安城市歴史博物館 特別展",   category: "culture", note: "定期：火曜12:00・金曜17:00" },
        { title: "刈谷ハイウェイオアシス",     category: "tourism", note: "定期：火曜12:00・金曜17:00" },
        { title: "エリアワン地域貢献活動",     category: "company", note: "定期：火曜12:00・金曜17:00" }
      ];
      let idx = 0;

      for(let d=1; d<=lastDay; d++){
        const date = new Date(year, month-1, d);
        const dow = date.getDay(); // 0=日
        if(dow === 2 || dow === 5){
          const key = `${year}-${month}-${d}`;
          if(!scheduleData[key]) scheduleData[key] = [];
          const tpl = templates[idx % templates.length];

          const exists = scheduleData[key].some(p => p.title === tpl.title && p.category === tpl.category);
          if(!exists){
            scheduleData[key].push({ title: tpl.title, category: tpl.category, note: tpl.note });
          }
          idx++;
        }
      }

      saveSchedule();
      generateCalendar();
      showCustomAlert("この月の基本スケジュールを追加しました（既存の予定は残したままです）。");
    }

    /* -------- カスタムダイアログ機能 -------- */
    function showCustomAlert(message) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.style.maxWidth = '400px';
      
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'margin-bottom:20px;line-height:1.6;white-space:pre-line;';
      messageDiv.textContent = message;
      
      const okButton = document.createElement('button');
      okButton.className = 'btn btn-primary';
      okButton.textContent = 'OK';
      okButton.onclick = () => {
        document.body.removeChild(modal);
      };
      
      modalContent.appendChild(messageDiv);
      modalContent.appendChild(okButton);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }

    function showCustomConfirm(message, onConfirm) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.style.maxWidth = '450px';
      
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'margin-bottom:20px;line-height:1.6;white-space:pre-line;';
      messageDiv.textContent = message;
      
      const buttonDiv = document.createElement('div');
      buttonDiv.style.cssText = 'display:flex;gap:12px;justify-content:flex-end;';
      
      const cancelButton = document.createElement('button');
      cancelButton.className = 'btn btn-secondary';
      cancelButton.textContent = 'キャンセル';
      cancelButton.onclick = () => {
        document.body.removeChild(modal);
      };
      
      const confirmButton = document.createElement('button');
      confirmButton.className = 'btn';
      confirmButton.style.cssText = 'background:#e53e3e;color:#fff;';
      confirmButton.textContent = '削除する';
      confirmButton.onclick = () => {
        document.body.removeChild(modal);
        onConfirm();
      };
      
      buttonDiv.appendChild(cancelButton);
      buttonDiv.appendChild(confirmButton);
      modalContent.appendChild(messageDiv);
      modalContent.appendChild(buttonDiv);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }

    /* -------- データエクスポート機能 -------- */
    function exportSchedule(){
      const dataCount = Object.keys(scheduleData).length;
      if(dataCount === 0){
        showCustomAlert("エクスポートするデータがありません。");
        return;
      }
      
      // 読みやすい形式でデータを整形
      let exportText = "=== Instagram投稿スケジュール ===\n\n";
      
      // 日付順にソート
      const sortedKeys = Object.keys(scheduleData).sort((a, b) => {
        const dateA = new Date(a.replace(/-/g, '/'));
        const dateB = new Date(b.replace(/-/g, '/'));
        return dateA - dateB;
      });
      
      sortedKeys.forEach(key => {
        const [year, month, day] = key.split('-');
        exportText += `【${year}年${month}月${day}日】\n`;
        
        scheduleData[key].forEach((post, index) => {
          const categoryNames = {
            sports: "スポーツ・ホームタウン",
            culture: "文化・教育施設", 
            tourism: "観光・飲食",
            company: "企業活動・地域貢献",
            stories: "ストーリーズ"
          };
          
          exportText += `  ${index + 1}. ${post.title}\n`;
          exportText += `     カテゴリ: ${categoryNames[post.category] || post.category}\n`;
          if(post.note) {
            exportText += `     メモ: ${post.note}\n`;
          }
          exportText += "\n";
        });
        
        exportText += "---\n\n";
      });
      
      // テキストエリアを作成して表示
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;';
      
      const content = document.createElement('div');
      content.style.cssText = 'background:white;padding:20px;border-radius:8px;max-width:80%;max-height:80%;overflow:auto;';
      
      const textarea = document.createElement('textarea');
      textarea.style.cssText = 'width:600px;height:400px;font-family:monospace;font-size:12px;';
      textarea.value = exportText;
      textarea.readOnly = true;
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = '閉じる';
      closeBtn.style.cssText = 'margin-top:10px;padding:8px 16px;';
      closeBtn.onclick = () => document.body.removeChild(modal);
      
      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'コピー';
      copyBtn.style.cssText = 'margin-top:10px;margin-left:10px;padding:8px 16px;background:#48bb78;color:white;border:none;border-radius:4px;';
      copyBtn.onclick = () => {
        textarea.select();
        try {
          document.execCommand('copy');
          showCustomAlert('データをクリップボードにコピーしました！');
        } catch (error) {
          showCustomAlert('コピーに失敗しました。手動でテキストを選択してコピーしてください。');
        }
      };
      
      content.appendChild(textarea);
      content.appendChild(document.createElement('br'));
      content.appendChild(copyBtn);
      content.appendChild(closeBtn);
      modal.appendChild(content);
      document.body.appendChild(modal);
    }

    /* -------- 初期化 -------- */
    window.addEventListener("DOMContentLoaded", ()=>{
      loadSchedule();
      initMonthOptions();
      generateCalendar();

      document.getElementById("month").addEventListener("change", generateCalendar);
      document.getElementById("year").addEventListener("change", generateCalendar);
    });

    // モーダル背景クリックで閉じる
    document.getElementById("editModal").addEventListener("click", (e)=>{
      if(e.target.id === "editModal") closeModal();
    });
  </script>
</body>
</html>